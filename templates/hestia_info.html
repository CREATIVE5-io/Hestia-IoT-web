<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>NTN Information</title>
    <link rel="stylesheet" href="/static/apple_style.css?v=1754543089">
    <style>
        /* Force CSS rules for Chrome desktop */
        .sidebar {
            position: fixed !important;
            left: 0 !important;
            top: 0 !important;
            width: 240px !important;
            height: 100vh !important;
            z-index: 1000 !important;
        }
        .main-content {
            margin-left: 240px !important;
            flex: 1 !important;
        }
        body {
            display: flex !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%) !important; }
            .main-content { margin-left: 0 !important; }
        }

        /* LED Indicator Styles */
        .led-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #333;
            box-shadow: 0 0 3px rgba(0,0,0,0.3);
        }

        .led-green {
            background-color: #00ff00;
            box-shadow: 0 0 6px #00ff00;
        }

        .led-red {
            background-color: #ff0000;
            box-shadow: 0 0 6px #ff0000;
        }

        .status-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .status-label {
            min-width: 180px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    {% include 'sidebar.html' %}

    <div class="main-content">
        <div class="container mt-4">
        <!-- Flash messages go here -->
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-info">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <h1>Hestia Information</h1>

        <!-- Serial Interface Configuration -->
        <form method="POST">
            <h2>Serial Interface Configuration</h2>
            <input type="hidden" name="action" value="update_serial">
            <div class="form-group">
                <label for="serial_interface">Serial Interface:</label>
                <input type="text" id="serial_interface" name="serial_interface" value="{{ hestia_info.serial_interface|default('/dev/ttyUSB0') }}" required>
            </div>
            <div class="form-group">
                <button type="submit">Save Serial Interface</button>
            </div>
        </form>

        <!-- NTN Status Components -->
        <div class="info-container">
            <h2>NTN Status Details</h2>
            <div id="ntn-status-indicators" data-srv-mode="{{ hestia_info.srv_mode }}">
                <!-- Hidden raw status for JavaScript processing -->
                <span id="raw-status" style="display: none;">{{ hestia_info['ntn-status'] }}</span>

                <div id="dynamic-indicators">
                    <!-- LED indicators will be inserted here -->
                </div>
            </div>
        </div>

        <!-- NTN Network Details -->
        <div class="info-container">
            <h2>NTN Network Details</h2>
            <p><strong>IMSI:</strong> {{ hestia_info.imsi }}</p>
            <p><strong>RSRP:</strong> {{ hestia_info.rsrp }}</p>
            <p><strong>SINR:</strong> {{ hestia_info.sinr }}</p>
            <p><strong>Longitude:</strong> {{ hestia_info.longitude }}</p>
            <p><strong>Latitude:</strong> {{ hestia_info.latitude }}</p>
            <p><strong>Last Update:</strong> {{ hestia_info['last-update'] }}</p>
        </div>
        <div class='info-container'>
            <h2>Lora Device Information</h2>
            <p><strong>Device Address:</strong> {{ hestia_info['lora-info'].devAddr }}</p>
            <p><strong>Data:</strong> {{ hestia_info['lora-info'].data }}</p>
            <p><strong>RSSI:</strong> {{ hestia_info['lora-info'].rssi }}</p>
            <p><strong>SNR:</strong> {{ hestia_info['lora-info'].snr }}</p>
            <p><strong>Last Update:</strong> {{ hestia_info['lora-info']['last-update'] }}</p>
        </div>

        <form method="POST" action="">
            <button type="submit" name="action" value="start_hestia_info" class="btn btn-primary">Start Hestia Info</button>
            <button type="submit" name="action" value="stop_hestia_info" class="btn btn-primary">Stop Hestia Info</button>
        </form>
    </div>

    <!-- LED Indicators JavaScript -->
    <script>
        // Function to create LED indicator HTML with inline styles
        function createLEDIndicator(label, value) {
            var ledColor = value ? '#00ff00' : '#ff0000';
            var shadowColor = value ? '#00ff00' : '#ff0000';
            return '<div style="display: flex; align-items: center; margin: 5px 0;">' +
                '<span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: ' + ledColor + '; border: 1px solid #333; box-shadow: 0 0 6px ' + shadowColor + '; margin-right: 8px;"></span>' +
                '<span style="min-width: 180px; font-weight: bold;">' + label + ':</span>' +
                '<span>' + value + '</span>' +
                '</div>';
        }

        // Function to parse and display NTN status with LED indicators
        function updateNTNStatusIndicators() {
            var rawStatusElement = document.getElementById('raw-status');
            var dynamicContainer = document.getElementById('dynamic-indicators');

            if (!rawStatusElement || !dynamicContainer) {
                return;
            }

            var rawStatus = rawStatusElement.textContent.trim();

            // Auto-detect srv_mode from status data if downlink_ready is present (NIDD mode)
            var srvMode = rawStatus.includes('downlink_ready') ? 1 : 2;

            try {
                // More robust Python dict to JSON conversion
                var jsFormat = rawStatus
                    .replace(/'/g, '"')                    // Replace single quotes with double quotes
                    .replace(/True/g, 'true')              // Replace Python True with JSON true
                    .replace(/False/g, 'false')            // Replace Python False with JSON false
                    .replace(/\(/g, '[')                   // Replace tuple opening ( with array [
                    .replace(/\)/g, ']');                  // Replace tuple closing ) with array ]

                var statusObj = JSON.parse(jsFormat);

                // Create LED indicators based on srv_mode
                var indicatorsHTML = '<div style="margin: 10px 0;">';
                // indicatorsHTML += '<p><strong>Service Mode:</strong> ' + (srvMode === 1 ? 'NIDD' : 'UDP') + ' (' + srvMode + ')</p>';

                // Common indicators for both modes
                indicatorsHTML += createLEDIndicator('Module AT Ready', statusObj.module_at_ready || false);

                if (srvMode === 1) {
                    // NIDD mode indicators
                    indicatorsHTML += createLEDIndicator('Downlink Ready', statusObj.downlink_ready || false);
                    indicatorsHTML += createLEDIndicator('SIM Ready', statusObj.sim_ready || false);
                    indicatorsHTML += createLEDIndicator('Network Registered', statusObj.network_registered || false);
                } else {
                    // UDP mode indicators
                    indicatorsHTML += createLEDIndicator('IP Ready', statusObj.ip_ready || false);
                    indicatorsHTML += createLEDIndicator('SIM Ready', statusObj.sim_ready || false);
                    indicatorsHTML += createLEDIndicator('Network Registered', statusObj.network_registered || false);
                    indicatorsHTML += createLEDIndicator('Socket Ready', statusObj.socket_ready || false);
                }

                // All Ready indicator (common for both modes)
                indicatorsHTML += createLEDIndicator('All Ready', statusObj.all_ready || false);
                indicatorsHTML += '</div>';

                // Update the container
                dynamicContainer.innerHTML = indicatorsHTML;

            } catch (e) {
                // If parsing fails, show raw data and create manual indicators
                var indicatorsHTML = '<div style="margin: 10px 0;">';
                indicatorsHTML += '<p><strong>Service Mode:</strong> ' + (srvMode === 1 ? 'NIDD' : 'UDP') + ' (' + srvMode + ')</p>';
                indicatorsHTML += '<p style="color: orange;">Raw status: ' + rawStatus + '</p>';

                // Manual parsing as fallback
                var isModuleReady = rawStatus.indexOf("'module_at_ready': True") > -1;
                var isDownlinkReady = rawStatus.indexOf("'downlink_ready': True") > -1;
                var isIpReady = rawStatus.indexOf("'ip_ready': True") > -1;
                var isSimReady = rawStatus.indexOf("'sim_ready': True") > -1;
                var isNetworkReady = rawStatus.indexOf("'network_registered': True") > -1;
                var isSocketReady = rawStatus.indexOf("'socket_ready': True") > -1;
                var isAllReady = rawStatus.indexOf("'all_ready': True") > -1;

                indicatorsHTML += createLEDIndicator('Module AT Ready', isModuleReady);

                if (srvMode === 1) {
                    indicatorsHTML += createLEDIndicator('Downlink Ready', isDownlinkReady);
                    indicatorsHTML += createLEDIndicator('SIM Ready', isSimReady);
                    indicatorsHTML += createLEDIndicator('Network Registered', isNetworkReady);
                } else {
                    indicatorsHTML += createLEDIndicator('IP Ready', isIpReady);
                    indicatorsHTML += createLEDIndicator('SIM Ready', isSimReady);
                    indicatorsHTML += createLEDIndicator('Network Registered', isNetworkReady);
                    indicatorsHTML += createLEDIndicator('Socket Ready', isSocketReady);
                }

                indicatorsHTML += createLEDIndicator('All Ready', isAllReady);
                indicatorsHTML += '</div>';

                dynamicContainer.innerHTML = indicatorsHTML;
            }
        }

        // Function to fetch and update data without page reload
        function checkForUpdates() {
            fetch('/hestia_info_data')
                .then(response => response.json())
                .then(data => {
                    // Update the hidden status element with new data
                    const rawStatusElement = document.getElementById('raw-status');
                    if (rawStatusElement && data.hestia_info && data.hestia_info['ntn-status']) {
                        rawStatusElement.textContent = data.hestia_info['ntn-status'];
                        // Update LED indicators with new data
                        updateNTNStatusIndicators();
                    }
                })
                .catch(error => {
                    console.error('Error fetching updates:', error);
                });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(updateNTNStatusIndicators, 100);

            // Start auto-update every 5 seconds
            setInterval(checkForUpdates, 5000);
        });

        // Also update when window loads
        window.addEventListener('load', function() {
            updateNTNStatusIndicators();
        });
    </script>
        </div>
    </div>
</body>
</html>
