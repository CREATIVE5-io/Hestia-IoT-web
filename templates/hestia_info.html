<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>NTN Information</title>
    <link rel="stylesheet" href="/static/apple_style.css?v=1754543089">
    <style>
        /* Force CSS rules for Chrome desktop */
        .sidebar {
            position: fixed !important;
            left: 0 !important;
            top: 0 !important;
            width: 240px !important;
            height: 100vh !important;
            z-index: 1000 !important;
        }
        .main-content {
            margin-left: 240px !important;
            flex: 1 !important;
        }
        body {
            display: flex !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%) !important; }
            .main-content { margin-left: 0 !important; }
        }

        /* LED Indicator Styles */
        .led-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #333;
            box-shadow: 0 0 3px rgba(0,0,0,0.3);
        }

        .led-green {
            background-color: #00ff00;
            box-shadow: 0 0 6px #00ff00;
        }

        .led-red {
            background-color: #ff0000;
            box-shadow: 0 0 6px #ff0000;
        }

        .status-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .status-label {
            min-width: 180px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    {% include 'sidebar.html' %}

    <div class="main-content">
        <div class="container mt-4">
        <!-- Flash messages go here -->
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-info">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <h1>Hestia Information</h1>

        <!-- Serial Interface Configuration -->
        <form method="POST">
            <h2>Serial Interface Configuration</h2>
            <input type="hidden" name="action" value="update_serial">
            <div class="form-group">
                <label for="serial_interface">Serial Interface:</label>
                <input type="text" id="serial_interface" name="serial_interface" value="{{ hestia_info.serial_interface|default('/dev/ttyUSB0') }}" required>
            </div>
            <div class="form-group">
                <button type="submit">Save Serial Interface</button>
            </div>
        </form>

        <!-- NTN Information Row -->
        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
            <!-- NTN Status Details -->
            <div class="info-container" style="flex: 1;">
                <h2>NTN Status Details</h2>
                <div id="ntn-status-indicators" data-srv-mode="{{ hestia_info.srv_mode }}">
                    <!-- Hidden raw status for JavaScript processing -->
                    <span id="raw-status" style="display: none;">{{ hestia_info['ntn-status'] }}</span>

                    <div id="dynamic-indicators">
                        <!-- LED indicators will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- NTN Network Details -->
            <div class="info-container" style="flex: 1;">
                <h2>NTN Network Details</h2>
                <p><strong>IMSI:</strong> {{ hestia_info.imsi }}</p>
                <p><strong>RSRP:</strong> {{ hestia_info.rsrp }}</p>
                <p><strong>SINR:</strong> {{ hestia_info.sinr }}</p>
                <p><strong>Longitude:</strong> {{ hestia_info.longitude }}</p>
                <p><strong>Latitude:</strong> {{ hestia_info.latitude }}</p>
                <p><strong>Last Update:</strong> {{ hestia_info['last-update'] }}</p>
            </div>
        </div>

        <!-- Downlink Messages -->
        <div class="info-container">
            <h2>Downlink Messages</h2>
            <div id="downlink-messages">
                <p><em>No messages received yet...</em></p>
            </div>
            <button onclick="clearMessages()" style="margin: 10px 0; padding: 5px 10px; background: #ff6b6b; color: white; border: none; border-radius: 4px;">Clear Messages</button>
        </div>

        <div class='info-container'>
            <h2>Lora Device Information</h2>
            <p><strong>Device Address:</strong> {{ hestia_info['lora-info'].devAddr }}</p>
            <p><strong>Data:</strong> {{ hestia_info['lora-info'].data }}</p>
            <p><strong>RSSI:</strong> {{ hestia_info['lora-info'].rssi }}</p>
            <p><strong>SNR:</strong> {{ hestia_info['lora-info'].snr }}</p>
            <p><strong>Last Update:</strong> {{ hestia_info['lora-info']['last-update'] }}</p>
        </div>

        <form method="POST" action="">
            <button type="submit" name="action" value="start_hestia_info" class="btn btn-primary">Start Hestia Info</button>
            <button type="submit" name="action" value="stop_hestia_info" class="btn btn-primary">Stop Hestia Info</button>
        </form>
    </div>

    <!-- LED Indicators JavaScript -->
    <script>
        // Function to create LED indicator HTML with inline styles
        function createLEDIndicator(label, value) {
            var ledColor = value ? '#00ff00' : '#ff0000';
            var shadowColor = value ? '#00ff00' : '#ff0000';
            return '<div style="display: flex; align-items: center; margin: 5px 0;">' +
                '<span style="min-width: 180px; font-weight: bold;">' + label + ':</span>' +
                '<span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: ' + ledColor + '; border: 1px solid #333; box-shadow: 0 0 6px ' + shadowColor + '; margin-left: 8px;"></span>' +
                '</div>';
        }

        // Function to parse and display NTN status with LED indicators
        function updateNTNStatusIndicators() {
            var rawStatusElement = document.getElementById('raw-status');
            var dynamicContainer = document.getElementById('dynamic-indicators');

            if (!rawStatusElement || !dynamicContainer) {
                return;
            }

            var rawStatus = rawStatusElement.textContent.trim();

            // Auto-detect srv_mode from status data if downlink_ready is present (NIDD mode)
            var srvMode = rawStatus.includes('downlink_ready') ? 1 : 2;

            try {
                // More robust Python dict to JSON conversion
                var jsFormat = rawStatus
                    .replace(/'/g, '"')                    // Replace single quotes with double quotes
                    .replace(/True/g, 'true')              // Replace Python True with JSON true
                    .replace(/False/g, 'false')            // Replace Python False with JSON false
                    .replace(/\(/g, '[')                   // Replace tuple opening ( with array [
                    .replace(/\)/g, ']');                  // Replace tuple closing ) with array ]

                var statusObj = JSON.parse(jsFormat);

                // Create LED indicators based on srv_mode
                var indicatorsHTML = '<div style="margin: 10px 0;">';
                // indicatorsHTML += '<p><strong>Service Mode:</strong> ' + (srvMode === 1 ? 'NIDD' : 'UDP') + ' (' + srvMode + ')</p>';

                // Common indicators for both modes
                indicatorsHTML += createLEDIndicator('Module AT Ready', statusObj.module_at_ready || false);

                if (srvMode === 1) {
                    // NIDD mode indicators
                    indicatorsHTML += createLEDIndicator('Downlink Ready', statusObj.downlink_ready || false);
                    indicatorsHTML += createLEDIndicator('SIM Ready', statusObj.sim_ready || false);
                    indicatorsHTML += createLEDIndicator('Network Registered', statusObj.network_registered || false);
                } else {
                    // UDP mode indicators
                    indicatorsHTML += createLEDIndicator('IP Ready', statusObj.ip_ready || false);
                    indicatorsHTML += createLEDIndicator('SIM Ready', statusObj.sim_ready || false);
                    indicatorsHTML += createLEDIndicator('Network Registered', statusObj.network_registered || false);
                    indicatorsHTML += createLEDIndicator('Socket Ready', statusObj.socket_ready || false);
                }

                // All Ready indicator (common for both modes)
                indicatorsHTML += createLEDIndicator('All Ready', statusObj.all_ready || false);
                indicatorsHTML += '</div>';

                // Update the container
                dynamicContainer.innerHTML = indicatorsHTML;

            } catch (e) {
                // If parsing fails, show raw data and create manual indicators
                var indicatorsHTML = '<div style="margin: 10px 0;">';
                indicatorsHTML += '<p><strong>Service Mode:</strong> ' + (srvMode === 1 ? 'NIDD' : 'UDP') + ' (' + srvMode + ')</p>';
                indicatorsHTML += '<p style="color: orange;">Raw status: ' + rawStatus + '</p>';

                // Manual parsing as fallback
                var isModuleReady = rawStatus.indexOf("'module_at_ready': True") > -1;
                var isDownlinkReady = rawStatus.indexOf("'downlink_ready': True") > -1;
                var isIpReady = rawStatus.indexOf("'ip_ready': True") > -1;
                var isSimReady = rawStatus.indexOf("'sim_ready': True") > -1;
                var isNetworkReady = rawStatus.indexOf("'network_registered': True") > -1;
                var isSocketReady = rawStatus.indexOf("'socket_ready': True") > -1;
                var isAllReady = rawStatus.indexOf("'all_ready': True") > -1;

                indicatorsHTML += createLEDIndicator('Module AT Ready', isModuleReady);

                if (srvMode === 1) {
                    indicatorsHTML += createLEDIndicator('Downlink Ready', isDownlinkReady);
                    indicatorsHTML += createLEDIndicator('SIM Ready', isSimReady);
                    indicatorsHTML += createLEDIndicator('Network Registered', isNetworkReady);
                } else {
                    indicatorsHTML += createLEDIndicator('IP Ready', isIpReady);
                    indicatorsHTML += createLEDIndicator('SIM Ready', isSimReady);
                    indicatorsHTML += createLEDIndicator('Network Registered', isNetworkReady);
                    indicatorsHTML += createLEDIndicator('Socket Ready', isSocketReady);
                }

                indicatorsHTML += createLEDIndicator('All Ready', isAllReady);
                indicatorsHTML += '</div>';

                dynamicContainer.innerHTML = indicatorsHTML;
            }
        }

        // Function to update data fields by finding and updating text content
        function updateInfoFields(info) {
            // Get all paragraph elements
            const paragraphs = document.querySelectorAll('p');

            paragraphs.forEach(function(p) {
                const text = p.innerHTML;

                // Update NTN Network Details
                if (text.includes('<strong>IMSI:</strong>')) {
                    p.innerHTML = '<strong>IMSI:</strong> ' + (info.imsi || '');
                }
                else if (text.includes('<strong>RSRP:</strong>')) {
                    p.innerHTML = '<strong>RSRP:</strong> ' + (info.rsrp || '');
                }
                else if (text.includes('<strong>SINR:</strong>')) {
                    p.innerHTML = '<strong>SINR:</strong> ' + (info.sinr || '');
                }
                else if (text.includes('<strong>Longitude:</strong>')) {
                    p.innerHTML = '<strong>Longitude:</strong> ' + (info.longitude || '');
                }
                else if (text.includes('<strong>Latitude:</strong>')) {
                    p.innerHTML = '<strong>Latitude:</strong> ' + (info.latitude || '');
                }
                else if (text.includes('<strong>Last Update:</strong>') && !text.includes('LoRa')) {
                    p.innerHTML = '<strong>Last Update:</strong> ' + (info['last-update'] || '');
                }

                // Update LoRa Device Information
                if (info['lora-info']) {
                    const loraInfo = info['lora-info'];

                    if (text.includes('<strong>Device Address:</strong>')) {
                        p.innerHTML = '<strong>Device Address:</strong> ' + (loraInfo.devAddr || '');
                    }
                    else if (text.includes('<strong>Data:</strong>')) {
                        p.innerHTML = '<strong>Data:</strong> ' + (loraInfo.data || '');
                    }
                    else if (text.includes('<strong>RSSI:</strong>')) {
                        p.innerHTML = '<strong>RSSI:</strong> ' + (loraInfo.rssi || '');
                    }
                    else if (text.includes('<strong>SNR:</strong>')) {
                        p.innerHTML = '<strong>SNR:</strong> ' + (loraInfo.snr || '');
                    }
                    else if (text.includes('<strong>Last Update:</strong>') && text.includes('LoRa')) {
                        p.innerHTML = '<strong>Last Update:</strong> ' + (loraInfo['last-update'] || '');
                    }
                }
            });
        }

        // Function to fetch and update data without page reload
        function checkForUpdates() {
            fetch('/hestia_info_data')
                .then(response => response.json())
                .then(data => {
                    if (data.hestia_info) {
                        const info = data.hestia_info;

                        // Update NTN Status LED indicators
                        const rawStatusElement = document.getElementById('raw-status');
                        if (rawStatusElement && info['ntn-status']) {
                            rawStatusElement.textContent = info['ntn-status'];
                            updateNTNStatusIndicators();
                        }

                        // Update all info fields
                        updateInfoFields(info);

                        // Update downlink messages if available
                        if (info.downlink_messages) {
                            updateDownlinkMessages(info.downlink_messages);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching updates:', error);
                });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(updateNTNStatusIndicators, 100);
            setTimeout(initializeDownlinkMessages, 200);

            // Start auto-update every 5 seconds
            setInterval(checkForUpdates, 5000);
        });

        // Function to update downlink messages
        function updateDownlinkMessages(messages) {
            const container = document.getElementById('downlink-messages');
            if (!container) {
                return;
            }

            if (!messages || messages.length === 0) {
                container.innerHTML = '<p><em>No messages received yet...</em></p>';
                return;
            }

            let messagesHTML = '';
            messages.forEach(function(message, index) {
                messagesHTML += '<div style="margin: 5px 0; padding: 8px; background: #f0f0f0; border-left: 3px solid #007AFF; border-radius: 3px;">';
                messagesHTML += '<div style="font-size: 12px; color: #666; margin-bottom: 3px;">' + (message.timestamp || 'Unknown time') + '</div>';

                // Show raw hex data
                messagesHTML += '<div style="font-family: monospace; font-size: 13px; color: #333; margin-bottom: 5px; word-break: break-all;">' + (message.data || 'No data') + '</div>';

                // Try to decode hex data to readable JSON
                try {
                    var hexData = message.data || '';
                    if (hexData.length > 0) {
                        // Convert hex string to bytes, then to string, then parse as JSON
                        var decodedString = '';
                        for (var i = 0; i < hexData.length; i += 2) {
                            decodedString += String.fromCharCode(parseInt(hexData.substr(i, 2), 16));
                        }
                        var parsedData = JSON.parse(decodedString);
                        messagesHTML += '<div style="font-family: monospace; font-size: 13px; color: #007AFF; background: #f8f8f8; padding: 4px; border-radius: 2px; margin-bottom: 3px;">';
                        //messagesHTML += JSON.stringify(parsedData, null, 2).replace(/\n/g, '<br>').replace(/ /g, '&nbsp;');
                        messagesHTML += JSON.stringify(parsedData);
                        messagesHTML += '</div>';
                    }
                } catch (e) {
                    // If decoding fails, just show the raw data (already shown above)
                }

                messagesHTML += '<div style="font-size: 11px; color: #888; margin-top: 3px;">Length: ' + (message.length || 0) + ' bytes</div>';
                messagesHTML += '</div>';
            });

            container.innerHTML = messagesHTML;
        }

        // Initialize downlink messages on page load
        function initializeDownlinkMessages() {
            // Check if we have initial data
            const initialData = {{ hestia_info | tojson }};
            if (initialData && initialData.downlink_messages) {
                updateDownlinkMessages(initialData.downlink_messages);
            }
        }

        // Function to clear messages
        function clearMessages() {
            fetch('/hestia_info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'action=clear_messages'
            })
            .then(function() {
                const container = document.getElementById('downlink-messages');
                if (container) {
                    container.innerHTML = '<p><em>Messages cleared...</em></p>';
                }
            })
            .catch(function(error) {
                console.error('Error clearing messages:', error);
            });
        }

        // Also update when window loads
        window.addEventListener('load', function() {
            updateNTNStatusIndicators();
        });
    </script>
        </div>
    </div>
</body>
</html>
